<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Funds - Coin Purchase</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Segoe UI",sans-serif;
}

body{
  background:#f4f6fb;
  min-height:100vh;
  padding-top:60px;
}

/* ===== HEADER ===== */
.header{
  height:60px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  position:fixed;
  top:0;
  left:0;
  right:0;
  z-index:1000;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}

.logo{
  font-size:18px;
  font-weight:700;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.profile-circle {
  width: 36px;
  height: 36px;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 16px;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
}

.menu-btn{
  background:rgba(255,255,255,0.2);
  border:none;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:6px;
}

/* ===== MENU BAR ===== */
.menu{
  position:fixed;
  top:60px;
  right:-260px;
  width:260px;
  height:calc(100vh - 60px);
  background:#ffffff;
  box-shadow:-5px 0 20px rgba(0,0,0,0.15);
  transition:0.3s ease-in-out;
  z-index:1001;
  overflow-y:auto;
  padding-bottom:20px;
}

.menu.active{
  right:0;
}

.menu-balance{
  background:#f5f6ff;
  padding:16px;
  font-weight:600;
  color:#333;
  border-bottom:1px solid #eee;
  display:flex;
  align-items:center;
}

.menu-balance i{
  color:#667eea;
  margin-right:10px;
}

#balanceAmount {
  color: #4CAF50;
  font-weight: 700;
  margin-left: 5px;
}

.menu a{
  display:flex;
  align-items:center;
  gap:10px;
  padding:14px 16px;
  color:#333;
  text-decoration:none;
  font-size:14px;
  border-bottom:1px solid #f1f1f1;
  transition:0.2s;
  cursor:pointer;
}

.menu a i{
  width:18px;
  color:#667eea;
}

.menu a:hover{
  background:#f7f8ff;
  padding-left:20px;
}

.menu a.active {
  background: #f0f5ff;
  color: #667eea;
  font-weight: 600;
  border-left: 3px solid #667eea;
 }

/* ===== PAGE CONTENT ===== */
.content{
  padding:16px;
  min-height:calc(100vh - 60px);
}

/* ===== SEARCH BAR ===== */
.search-section {
  margin-bottom: 20px;
}

.search-bar {
  position: relative;
}

.search-bar input {
  width: 100%;
  padding: 12px 20px 12px 45px;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 14px;
  background-color: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.search-bar i {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: #888;
}

/* ===== CARDS SECTION ===== */
.cards-section {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
  margin-bottom: 25px;
}

.service-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.service-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}

.card-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.card-icon {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  color: white;
  font-size: 22px;
}

.card-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 3px;
}

.card-subtitle {
  font-size: 12px;
  color: #888;
}

/* ===== ORDER FORM ===== */
.order-form {
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  margin-bottom: 25px;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title i {
  color: #667eea;
}

.form-group {
  margin-bottom: 20px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
    gap: 15px;
  }
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #555;
  font-size: 14px;
}

.form-label i {
  margin-right: 8px;
  color: #667eea;
}

.form-input {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  transition: border 0.3s;
  background-color: #fafafa;
}

.form-input:focus {
  outline: none;
  border-color: #667eea;
  background-color: #fff;
}

.form-input:disabled {
  background-color: #eee;
  cursor: not-allowed;
}

.form-hint {
  font-size: 12px;
  color: #888;
  margin-top: 5px;
  margin-left: 5px;
}

/* ===== PAYMENT SELECTION ===== */
.payment-selection {
  margin-bottom: 25px;
}

.payment-options {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.payment-btn {
  flex: 1;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 10px;
  background: #f9f9f9;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-weight: 600;
  color: #555;
  cursor: pointer;
  transition: all 0.3s;
}

.payment-btn:hover {
  background: #f0f0f0;
}

.payment-btn.active {
  border-color: #667eea;
  background: #f0f4ff;
  color: #667eea;
}

.payment-btn i {
  font-size: 20px;
}

/* ===== PAYMENT DETAILS ===== */
.payment-details {
  background: #f9f9ff;
  border-radius: 10px;
  padding: 20px;
  border: 1px solid #e0e0ff;
  margin-top: 20px;
}

.payment-details.hidden {
  display: none;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px dashed #ddd;
}

.detail-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.detail-label {
  font-weight: 500;
  color: #555;
}

.detail-value {
  font-weight: 600;
  color: #333;
}

/* ===== ORDER BUTTON ===== */
.order-btn-container {
  text-align: center;
  margin-top: 30px;
}

.order-btn {
  background: linear-gradient(135deg, #4CAF50, #2E7D32);
  color: white;
  border: none;
  padding: 16px 40px;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.order-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

.order-btn:disabled {
  background: #cccccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* ===== MODAL ===== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  width: 90%;
  max-width: 400px;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 20px;
  text-align: center;
}

.modal-header i {
  font-size: 40px;
  margin-bottom: 10px;
}

.modal-body {
  padding: 25px;
  text-align: center;
}

.modal-body h3 {
  margin-bottom: 10px;
  color: #333;
  font-size: 18px;
}

.modal-body p {
  color: #666;
  margin-bottom: 15px;
  line-height: 1.5;
  font-size: 14px;
}

.order-id {
  font-size: 32px;
  font-weight: 700;
  color: #4CAF50;
  letter-spacing: 4px;
  margin: 20px 0;
  padding: 15px;
  background: #f0f9f0;
  border-radius: 10px;
  font-family: monospace;
  border: 2px solid #4CAF50;
}

/* ===== MINI PENDING STATUS ===== */
.mini-pending-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-top: 10px;
  padding: 6px 12px;
  background: #fff3cd;
  border-radius: 20px;
  font-size: 11px;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.mini-pending-status i {
  font-size: 10px;
}

.modal-footer {
  padding: 20px;
  background: #f9f9f9;
  text-align: center;
  border-top: 1px solid #eee;
}

.ok-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}

/* ===== ERROR MESSAGE ===== */
.error-message {
  background: #ffebee;
  color: #c62828;
  padding: 12px 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #c62828;
  display: none;
  align-items: center;
  gap: 10px;
}

.error-message.active {
  display: flex;
}

/* ===== LOADING ===== */
.loading {
  display: none;
  text-align: center;
  padding: 20px;
}

.loading.active {
  display: block;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== OVERLAY FOR MENU ===== */
.menu-overlay {
  display: none;
  position: fixed;
  top: 60px;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

.menu-overlay.active {
  display: block;
}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <div class="logo">Add Funds</div>
  
  <div class="user-profile" onclick="toggleMenu()">
    <div class="profile-circle" id="profileInitial">?</div>
    <div class="user-name" id="userName">Loading...</div>
  </div>
  
  <button class="menu-btn" onclick="toggleMenu()">
    <i class="fas fa-bars"></i> Menu
  </button>
</div>

<!-- ===== MENU OVERLAY ===== -->
<div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

<!-- ===== MENU ===== -->
<div class="menu" id="menu">
  <div class="menu-balance">
    <i class="fas fa-wallet"></i>
    Balance: <span id="balanceAmount">$0.00</span>
  </div>

  <a id="dashboardLink">
    <i class="fas fa-home"></i>
    Dashboard
  </a>

  <a id="boostServiceLink">
    <i class="fas fa-rocket"></i>
    Boost Service
  </a>

  <a id="otherServiceLink">
    <i class="fas fa-layer-group"></i>
    Other Service
  </a>

  <a class ="active">
    <i class="fas fa-plus-circle"></i>
    Add Funds
  </a>

  <a id="orderHistoryLink">
    <i class="fas fa-history"></i>
    Order History
  </a>

  <a id="botPanelLink">
    <i class="fas fa-robot"></i>
    Panel
  </a>

  <a id="logoutLink">
    <i class="fas fa-sign-out-alt"></i>
    Logout
  </a>
</div>

<!-- ===== CONTENT ===== -->
<div class="content">
  <!-- Error Message -->
  <div class="error-message" id="errorMessage">
    <i class="fas fa-exclamation-circle"></i>
    <span id="errorText"></span>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Processing your order...</p>
  </div>

  <!-- Search Bar -->
  <div class="search-section">
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Search services...">
    </div>
  </div>

  <!-- Services Cards -->
  <!-- Order Form -->
  <div class="order-form">
    <div class="section-title">
      <i class="fas fa-shopping-cart"></i>
      Order Coins
    </div>
    
    <!-- Quantity & Cost -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="quantity">
          <i class="fas fa-hashtag"></i> Quantity (USD)
        </label>
        <input type="text" class="form-input" id="quantity" 
               placeholder="Enter amount (e.g., 1, 5, 10)"
               oninput="updateCost()">
        <div class="form-hint">Enter only numbers (1, 2, 5, 10, etc.)</div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="cost">
          <i class="fas fa-money-bill-wave"></i> Cost (MMK)
        </label>
        <input type="text" class="form-input" id="cost" readonly>
        <div class="form-hint">Auto calculated based on quantity</div>
      </div>
    </div>
    
    <!-- Note -->
    <div class="form-group">
      <label class="form-label" for="note">
        <i class="fas fa-sticky-note"></i> Note about Coins
      </label>
      <input type="text" class="form-input" id="note" 
             value="1 USD = 3500 MMK Coins. Coins can be used for all services." 
             readonly>
    </div>
    
    <!-- Payment Selection -->
    <div class="payment-selection">
      <div class="section-title">
        <i class="fas fa-credit-card"></i>
        Select Payment Method
      </div>
      
      <div class="payment-options">
        <div class="payment-btn" id="kpayBtn" onclick="selectPayment('kpay')">
          <i class="fas fa-mobile-alt"></i>
          KBZ Pay
        </div>
        <div class="payment-btn" id="waveBtn" onclick="selectPayment('wave')">
          <i class="fas fa-wave-square"></i>
          Wave Pay
        </div>
      </div>
      
      <!-- KBZ Pay Details -->
      <div class="payment-details" id="kpayDetails">
        <div class="detail-row">
          <span class="detail-label">KBZ Pay Name:</span>
          <span class="detail-value">Zay Yar Lin</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">KBZ Pay No.:</span>
          <span class="detail-value">09686218508</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Note:</span>
          <span class="detail-value">payment, Bill, zayyarlin</span>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label class="form-label" for="kpayId">
            <i class="fas fa-receipt"></i> KBZ Pay ID (Last 5 digits)
          </label>
          <input type="text" class="form-input" id="kpayId" 
                 placeholder="Enter last 5 digits of payment ID"
                 maxlength="5">
          <div class="form-hint">Enter the last 5 digits from your KBZ Pay receipt</div>
        </div>
      </div>
      
      <!-- Wave Pay Details -->
      <div class="payment-details hidden" id="waveDetails">
        <div class="detail-row">
          <span class="detail-label">Wave Pay Name:</span>
          <span class="detail-value">Maung Zaw</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Wave Pay No.:</span>
          <span class="detail-value">09686792683</span>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label class="form-label" for="waveId">
            <i class="fas fa-receipt"></i> Wave Pay ID (Last 5 digits)
          </label>
          <input type="text" class="form-input" id="waveId" 
                 placeholder="Enter last 5 digits of payment ID"
                 maxlength="5">
          <div class="form-hint">Enter the last 5 digits from your Wave Pay receipt</div>
        </div>
      </div>
    </div>
    
    <!-- Order Button -->
    <div class="order-btn-container">
      <button class="order-btn" id="orderBtn" onclick="placeOrder()">
        <i class="fas fa-shopping-cart"></i> Now Order Coins
      </button>
    </div>
  </div>
</div>

<!-- ===== SUCCESS MODAL ===== -->
<div class="modal" id="successModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-check-circle"></i>
      <h2>Order Submitted!</h2>
    </div>
    <div class="modal-body">
      <h3>Your order has been received</h3>
      <p>Your coins order has been submitted and is waiting for admin approval.</p>
      
      <div class="order-id" id="orderIdDisplay">123456</div>
      
      <div class="mini-pending-status">
        <i class="fas fa-clock"></i>
        <span>PENDING - Please wait for admin confirmation</span>
      </div>
      
      <p style="margin-top: 15px; font-size: 13px;">You can check the status of your order in the Order History page.</p>
    </div>
    <div class="modal-footer">
      <button class="ok-btn" onclick="closeModal()">
        <i class="fas fa-check"></i> OK
      </button>
    </div>
  </div>
</div>
<script>
// ============================
// PART 2: JavaScript
// ============================

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCcRzva_qeKlaUH7ORsvvb5F3wOEGTvjTY",
  authDomain: "knveto-d2a5b.firebaseapp.com",
  projectId: "knveto-d2a5b",
  storageBucket: "knveto-d2a5b.firebasestorage.app",
  messagingSenderId: "717672809912",
  appId: "1:717672809912:web:06134f4f9e5349e714fb4d"
};

// Initialize Firebase
let auth, db;
try {
  const app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  console.log("Firebase initialized successfully");
} catch (error) {
  console.error("Firebase initialization error:", error);
  auth = null;
  db = null;
}

// Check if Firebase is available
function isFirebaseAvailable() {
  return auth && db;
}

// DOM Elements
const menu = document.getElementById('menu');
const menuOverlay = document.getElementById('menuOverlay');
const profileInitial = document.getElementById('profileInitial');
const userName = document.getElementById('userName');
const balanceAmount = document.getElementById('balanceAmount');

// Menu links
const dashboardLink = document.getElementById('dashboardLink');
const boostServiceLink = document.getElementById('boostServiceLink');
const otherServiceLink = document.getElementById('otherServiceLink');
const orderHistoryLink = document.getElementById('orderHistoryLink');
const botPanelLink = document.getElementById('botPanelLink');
const logoutLink = document.getElementById('logoutLink');

// Order form elements
const quantityInput = document.getElementById('quantity');
const costInput = document.getElementById('cost');
const noteInput = document.getElementById('note');
const kpayBtn = document.getElementById('kpayBtn');
const waveBtn = document.getElementById('waveBtn');
const kpayDetails = document.getElementById('kpayDetails');
const waveDetails = document.getElementById('waveDetails');
const kpayIdInput = document.getElementById('kpayId');
const waveIdInput = document.getElementById('waveId');
const orderBtn = document.getElementById('orderBtn');
const errorMessage = document.getElementById('errorMessage');
const errorText = document.getElementById('errorText');
const loading = document.getElementById('loading');
const searchInput = document.getElementById('searchInput');

// Modal elements
const successModal = document.getElementById('successModal');
const orderIdDisplay = document.getElementById('orderIdDisplay');

// User data
let currentUser = null;
let userBalance = 0.00;
let selectedPayment = 'kpay';
let currentQuantity = 0;

// Constants
const EXCHANGE_RATE = 3500;

// Firebase collections
const COIN_ORDERS_COLLECTION = 'coinOrders';
const USERS_COLLECTION = 'users';

// Order status constants
const ORDER_STATUS = {
  PENDING: 'pending',
  PROCESSING: 'processing',
  COMPLETED: 'completed'
};

// Payment methods
const PAYMENT_METHODS = {
  KBZ_PAY: 'KBZ Pay',
  WAVE_PAY: 'Wave Pay'
};

// ===== MENU FUNCTIONS =====

function toggleMenu() {
  menu.classList.toggle('active');
  menuOverlay.classList.toggle('active');
  
  if (menu.classList.contains('active')) {
    document.body.style.overflow = 'hidden';
  } else {
    document.body.style.overflow = '';
  }
}

function closeMenu() {
  menu.classList.remove('active');
  menuOverlay.classList.remove('active');
  document.body.style.overflow = '';
}

menuOverlay.addEventListener('click', closeMenu);

document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' && menu.classList.contains('active')) {
    closeMenu();
  }
});

// ===== USER PROFILE FUNCTIONS =====

function getProfileInitial(displayName, email) {
  if (displayName && displayName.trim().length > 0) {
    return displayName.trim().charAt(0).toUpperCase();
  } else if (email && email.trim().length > 0) {
    return email.trim().charAt(0).toUpperCase();
  }
  return "?";
}

function updateBalanceDisplay() {
  balanceAmount.textContent = `$${userBalance.toFixed(2)}`;
}

function loadUserBalance(userId) {
  if (!isFirebaseAvailable()) {
    userBalance = 0;
    updateBalanceDisplay();
    return;
  }
  
  db.collection(USERS_COLLECTION).doc(userId).get()
    .then((doc) => {
      if (doc.exists) {
        const data = doc.data();
        userBalance = data.balance || 0;
        console.log("User balance loaded:", userBalance);
      }
      updateBalanceDisplay();
    })
    .catch((error) => {
      console.error("Error loading user balance:", error);
      userBalance = 0;
      updateBalanceDisplay();
    });
}

function updateUserProfile(user) {
  const displayName = user.displayName || "User";
  const email = user.email || "No email";
  
  const initial = getProfileInitial(displayName, email);
  profileInitial.textContent = initial;
  
  const firstName = displayName.split(' ')[0];
  userName.textContent = firstName;
  
  currentUser = user;
  
  loadUserBalance(user.uid);
}

// ===== NAVIGATION FUNCTIONS =====

function setupNavigation() {
  dashboardLink.addEventListener('click', function() {
    closeMenu();
    window.location.href = 'index.html';
  });
  
  boostServiceLink.addEventListener('click', function() {
    closeMenu();
    window.location.href = 'smmpanel.html';
  });
  
  otherServiceLink.addEventListener('click', function() {
    closeMenu();
    window.location.href = 'service.html';
  });
  
  orderHistoryLink.addEventListener('click', function() {
    closeMenu();
    window.location.href = 'history.html';
  });
  
  botPanelLink.addEventListener('click', function() {
    closeMenu();
    window.location.href = 'panel.html';
  });
  
  logoutLink.addEventListener('click', function() {
    closeMenu();
    if (auth) {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      });
    } else {
      window.location.href = 'login.html';
    }
  });
}

function checkAuthState() {
  if (!isFirebaseAvailable()) {
    profileInitial.textContent = "O";
    userName.textContent = "Offline";
    userBalance = 0;
    updateBalanceDisplay();
    setupNavigation();
    initOrderForm();
    return;
  }
  
  auth.onAuthStateChanged((user) => {
    if (user) {
      updateUserProfile(user);
      setupNavigation();
      initOrderForm();
    } else {
      window.location.href = 'login.html';
    }
  });
}

// ===== ORDER FORM FUNCTIONS =====

function initOrderForm() {
  selectPayment('kpay');
  
  quantityInput.addEventListener('input', function() {
    updateCost();
  });
  
  searchInput.addEventListener('input', function() {
    searchServices(this.value);
  });
  
  quantityInput.addEventListener('paste', function(e) {
    e.preventDefault();
    const pastedText = e.clipboardData.getData('text/plain');
    const numericValue = pastedText.replace(/[^0-9.]/g, '');
    
    const parts = numericValue.split('.');
    let validValue = parts[0];
    if (parts.length > 1) {
      validValue += '.' + parts.slice(1).join('').substring(0, 2);
    }
    
    this.value = validValue;
    updateCost();
  });
  
  quantityInput.addEventListener('keypress', function(e) {
    const char = String.fromCharCode(e.keyCode || e.which);
    if (!/[\d.]/.test(char)) {
      e.preventDefault();
    }
    
    if (char === '.' && this.value.includes('.')) {
      e.preventDefault();
    }
  });
}

function updateCost() {
  let value = quantityInput.value.replace(/[^0-9.]/g, '');
  
  const dots = value.split('.');
  if (dots.length > 2) {
    value = dots[0] + '.' + dots.slice(1).join('');
  }
  
  if (value === '' || value === '.') {
    quantityInput.value = '';
    costInput.value = '';
    currentQuantity = 0;
    return;
  }
  
  const num = parseFloat(value);
  if (isNaN(num)) {
    quantityInput.value = '';
    costInput.value = '';
    currentQuantity = 0;
    return;
  }
  
  quantityInput.value = num;
  currentQuantity = num;
  
  const cost = num * EXCHANGE_RATE;
  costInput.value = cost.toLocaleString() + ' MMK';
}

function selectPayment(method) {
  selectedPayment = method;
  
  if (method === 'kpay') {
    kpayBtn.classList.add('active');
    waveBtn.classList.remove('active');
    kpayDetails.classList.remove('hidden');
    waveDetails.classList.add('hidden');
  } else {
    kpayBtn.classList.remove('active');
    waveBtn.classList.add('active');
    kpayDetails.classList.add('hidden');
    waveDetails.classList.remove('hidden');
  }
}

function searchServices(query) {
  const cards = document.querySelectorAll('.service-card');
  const queryLower = query.toLowerCase();
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    if (text.includes(queryLower)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

// ===== ERROR & LOADING HANDLING =====

function showError(message) {
  errorText.textContent = message;
  errorMessage.classList.add('active');
  
  setTimeout(() => {
    errorMessage.classList.remove('active');
  }, 5000);
}

function hideError() {
  errorMessage.classList.remove('active');
}

function showLoading() {
  loading.classList.add('active');
  orderBtn.disabled = true;
  orderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
}

function hideLoading() {
  loading.classList.remove('active');
  orderBtn.disabled = false;
  orderBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Now Order Coins';
}

// ===== ORDER ID GENERATION (6 DIGITS) =====

function generateOrderId() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// ===== MODAL FUNCTIONS =====

function showSuccessModal(orderId) {
  // Format order ID with spaces for readability
  const formattedOrderId = orderId.match(/.{1,3}/g).join(' ');
  orderIdDisplay.textContent = formattedOrderId;
  successModal.classList.add('active');
  
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  successModal.classList.remove('active');
  document.body.style.overflow = '';
  
  resetForm();
}

function resetForm() {
  quantityInput.value = '';
  costInput.value = '';
  kpayIdInput.value = '';
  waveIdInput.value = '';
  currentQuantity = 0;
  hideError();
}

document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' && successModal.classList.contains('active')) {
    closeModal();
  }
});

// ===== ORDER VALIDATION =====

function validateOrderForm() {
  hideError();
  
  if (!currentQuantity || currentQuantity <= 0) {
    showError('Please enter a valid quantity (minimum 1 USD)');
    quantityInput.focus();
    return false;
  }
  
  if (!isFirebaseAvailable()) {
    showError('No internet connection. Please check your connection.');
    return false;
  }
  
  let paymentId = '';
  if (selectedPayment === 'kpay') {
    paymentId = kpayIdInput.value.trim();
    if (!paymentId || paymentId.length !== 5) {
      showError('Please enter a valid KBZ Pay ID (5 digits)');
      kpayIdInput.focus();
      return false;
    }
    
    if (!/^\d{5}$/.test(paymentId)) {
      showError('KBZ Pay ID must contain only numbers');
      kpayIdInput.focus();
      return false;
    }
  } else {
    paymentId = waveIdInput.value.trim();
    if (!paymentId || paymentId.length !== 5) {
      showError('Please enter a valid Wave Pay ID (5 digits)');
      waveIdInput.focus();
      return false;
    }
    
    if (!/^\d{5}$/.test(paymentId)) {
      showError('Wave Pay ID must contain only numbers');
      waveIdInput.focus();
      return false;
    }
  }
  
  return true;
}

// ===== ORDER PLACEMENT =====

async function placeOrder() {
  console.log("Starting order placement...");
  
  if (!validateOrderForm()) {
    return;
  }
  
  const paymentId = selectedPayment === 'kpay' 
    ? kpayIdInput.value.trim() 
    : waveIdInput.value.trim();
  
  const usdAmount = currentQuantity;
  const mmkAmount = usdAmount * EXCHANGE_RATE;
  const coinsAmount = mmkAmount;
  
  // Generate 6-digit order ID
  const orderId = generateOrderId();
  console.log("Generated 6-digit Order ID:", orderId);
  
  showLoading();
  
  try {
    const orderData = {
      userId: currentUser.uid,
      userEmail: currentUser.email,
      userName: currentUser.displayName || 'User',
      
      // Order details with 6-digit ID
      orderId: orderId,
      orderType: 'coin_purchase',
      quantity: usdAmount,
      cost: mmkAmount,
      coins: coinsAmount,
      
      // Payment details
      paymentMethod: selectedPayment === 'kpay' ? PAYMENT_METHODS.KBZ_PAY : PAYMENT_METHODS.WAVE_PAY,
      paymentId: paymentId,
      paymentName: selectedPayment === 'kpay' ? 'Zay Yar Lin' : 'Maung Zaw',
      paymentNumber: selectedPayment === 'kpay' ? '09686218508' : '09686792683',
      
      // Status - Always PENDING initially
      status: ORDER_STATUS.PENDING,
      statusMessage: 'Waiting for admin confirmation',
      
      // Timestamps
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    console.log("Saving order data:", orderData);
    
    // Save order to Firestore
    const orderRef = await db.collection(COIN_ORDERS_COLLECTION).add(orderData);
    console.log("✅ Order saved! Document ID:", orderRef.id);
    
    // Update user's last order
    try {
      await db.collection(USERS_COLLECTION).doc(currentUser.uid).update({
        lastOrderId: orderId,
        lastOrderTime: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (userError) {
      console.warn("User update failed (non-critical):", userError);
    }
    
    // Show success modal with 6-digit ID and mini Pending status
    hideLoading();
    showSuccessModal(orderId);
    
    console.log("✅ Order placement complete! Showing modal...");
    
  } catch (error) {
    console.error("❌ Error placing order:", error);
    
    hideLoading();
    
    let errorMessage = 'Failed to place order. ';
    if (error.code === 'permission-denied') {
      errorMessage += 'Permission denied.';
    } else if (error.code === 'unavailable') {
      errorMessage += 'Network error.';
    } else {
      errorMessage += error.message;
    }
    
    showError(errorMessage);
  }
}

// ===== INITIALIZATION =====

function initApp() {
  try {
    checkAuthState();
  } catch (error) {
    console.error('Initialization error:', error);
    profileInitial.textContent = "G";
    userName.textContent = "Guest";
    updateBalanceDisplay();
  }
}

// Start the app
window.addEventListener('DOMContentLoaded', initApp);

// ===== EXPORT FUNCTIONS =====
window.orderSystem = {
  placeOrder: placeOrder,
  generateOrderId: generateOrderId,
  showSuccessModal: showSuccessModal,
  closeModal: closeModal
};

console.log('Part 2: JavaScript Loaded');
</script>
<script>
// ============================
// PART 3: Advanced Features
// ============================

// ===== REAL-TIME ORDER UPDATES =====

// Setup real-time listener for order status changes
function setupOrderStatusListener() {
  if (!currentUser || !isFirebaseAvailable()) return;
  
  try {
    const ordersQuery = db.collection(COIN_ORDERS_COLLECTION)
      .where('userId', '==', currentUser.uid)
      .where('status', 'in', [ORDER_STATUS.PENDING, ORDER_STATUS.PROCESSING])
      .orderBy('createdAt', 'desc')
      .limit(5);
    
    ordersQuery.onSnapshot((snapshot) => {
      const pendingOrders = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        data.docId = doc.id;
        pendingOrders.push(data);
      });
      
      // Update pending orders count in menu
      updatePendingBadge(pendingOrders.length);
      
      // Check for completed orders
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'modified') {
          const order = change.doc.data();
          if (order.status === ORDER_STATUS.COMPLETED) {
            showOrderCompletedNotification(order);
          }
        }
      });
      
    }, (error) => {
      console.error("Error in order listener:", error);
    });
    
  } catch (error) {
    console.error("Error setting up order listener:", error);
  }
}

// Update pending badge in menu
function updatePendingBadge(count) {
  // Remove existing badge if any
  let existingBadge = document.querySelector('.menu-pending-badge');
  if (existingBadge) {
    existingBadge.remove();
  }
  
  if (count > 0) {
    const badge = document.createElement('span');
    badge.className = 'menu-pending-badge';
    badge.textContent = count;
    badge.style.cssText = `
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff4757;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
      font-weight: bold;
    `;
    
    const orderHistoryLink = document.getElementById('orderHistoryLink');
    if (orderHistoryLink) {
      orderHistoryLink.style.position = 'relative';
      orderHistoryLink.appendChild(badge);
    }
  }
}

// Show notification when order is completed
function showOrderCompletedNotification(order) {
  const notification = document.createElement('div');
  notification.className = 'order-completed-notification';
  notification.innerHTML = `
    <div class="notification-content">
      <i class="fas fa-check-circle"></i>
      <div>
        <h4>Order Completed!</h4>
        <p>Order #${order.orderId.match(/.{1,3}/g).join(' ')} has been completed.</p>
      </div>
    </div>
    <button class="notification-close" onclick="this.parentElement.remove()">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  // Add styles if not exists
  if (!document.querySelector('#completed-notification-styles')) {
    const styles = document.createElement('style');
    styles.id = 'completed-notification-styles';
    styles.textContent = `
      .order-completed-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        max-width: 300px;
        z-index: 9999;
        animation: slideInRight 0.3s ease;
        border-left: 4px solid #4CAF50;
      }
      
      .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }
      
      .notification-content i {
        font-size: 20px;
        color: #4CAF50;
      }
      
      .notification-content h4 {
        margin: 0 0 5px 0;
        font-size: 14px;
        font-weight: 600;
        color: #333;
      }
      
      .notification-content p {
        margin: 0;
        font-size: 12px;
        color: #666;
      }
      
      .notification-close {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        font-size: 14px;
        padding: 5px;
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    `;
    document.head.appendChild(styles);
  }
  
  document.body.appendChild(notification);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 5000);
}

// ===== ORDER LIMITS CHECK =====

async function checkOrderLimits() {
  if (!currentUser || !isFirebaseAvailable()) return true;
  
  try {
    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    // Check today's pending orders count
    const todayOrdersQuery = await db.collection(COIN_ORDERS_COLLECTION)
      .where('userId', '==', currentUser.uid)
      .where('createdAt', '>=', startOfDay)
      .where('status', 'in', [ORDER_STATUS.PENDING, ORDER_STATUS.PROCESSING])
      .get();
    
    const pendingOrdersCount = todayOrdersQuery.size;
    
    // Apply limits
    const MAX_DAILY_ORDERS = 10;
    const MAX_PENDING_ORDERS = 3;
    
    if (pendingOrdersCount >= MAX_PENDING_ORDERS) {
      showError(`You have ${pendingOrdersCount} pending orders. Please wait for them to be processed.`);
      return false;
    }
    
    const totalTodayOrders = todayOrdersQuery.size;
    if (totalTodayOrders >= MAX_DAILY_ORDERS) {
      showError(`Daily order limit (${MAX_DAILY_ORDERS}) reached. Please try again tomorrow.`);
      return false;
    }
    
    return true;
    
  } catch (error) {
    console.error('Error checking order limits:', error);
    return true; // Allow order if check fails
  }
}

// ===== ENHANCED ORDER PLACEMENT =====

async function placeOrderEnhanced() {
  // Check order limits first
  const canPlaceOrder = await checkOrderLimits();
  if (!canPlaceOrder) {
    return;
  }
  
  // Then proceed with order placement
  await placeOrder();
}

// Update order button to use enhanced function
orderBtn.onclick = placeOrderEnhanced;

// ===== ENHANCED USER PROFILE =====

function updateUserProfileEnhanced(user) {
  updateUserProfile(user);
  
  // Setup real-time listener
  setTimeout(() => {
    setupOrderStatusListener();
  }, 1000);
}

// ===== ENHANCED AUTH STATE CHECK =====

function checkAuthStateEnhanced() {
  if (!isFirebaseAvailable()) {
    profileInitial.textContent = "O";
    userName.textContent = "Offline";
    userBalance = 0;
    updateBalanceDisplay();
    setupNavigation();
    initOrderForm();
    return;
  }
  
  auth.onAuthStateChanged((user) => {
    if (user) {
      updateUserProfileEnhanced(user);
      setupNavigation();
      initOrderForm();
    } else {
      window.location.href = 'login.html';
    }
  });
}

// ===== BALANCE AUTO-REFRESH =====

function setupBalanceAutoRefresh(userId) {
  if (!userId) return;
  
  // Refresh balance every 30 seconds
  setInterval(() => {
    if (currentUser && currentUser.uid === userId) {
      loadUserBalance(userId);
    }
  }, 30000);
}

// ===== INPUT ENHANCEMENTS =====

function enhanceInputs() {
  // Add input validation styling
  [kpayIdInput, waveIdInput].forEach(input => {
    input.addEventListener('input', function() {
      // Only allow numbers
      this.value = this.value.replace(/[^0-9]/g, '');
      
      // Limit to 5 characters
      if (this.value.length > 5) {
        this.value = this.value.slice(0, 5);
      }
      
      // Add validation styling
      if (this.value.length === 5) {
        this.style.borderColor = '#4CAF50';
        this.style.backgroundColor = '#f8fff8';
      } else {
        this.style.borderColor = '';
        this.style.backgroundColor = '';
      }
    });
  });
  
  // Quantity input enhancements
  quantityInput.addEventListener('keydown', function(e) {
    // Increase by 1 with up arrow
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      let value = parseFloat(this.value) || 0;
      value += 1;
      this.value = value;
      updateCost();
    }
    // Decrease by 1 with down arrow (minimum 1)
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      let value = parseFloat(this.value) || 0;
      value = Math.max(1, value - 1);
      this.value = value;
      updateCost();
    }
  });
}

// ===== ENHANCED INITIALIZATION =====

function initEnhancedApp() {
  try {
    // Setup enhanced auth state listener
    checkAuthStateEnhanced();
    
    // Add input enhancements
    enhanceInputs();
    
    // Setup balance auto-refresh
    setTimeout(() => {
      if (currentUser) {
        setupBalanceAutoRefresh(currentUser.uid);
      }
    }, 2000);
    
  } catch (error) {
    console.error('Enhanced app initialization error:', error);
    profileInitial.textContent = "G";
    userName.textContent = "Guest";
    updateBalanceDisplay();
  }
}

// ===== FINAL INITIALIZATION =====

// Override the original initialization with enhanced version
window.addEventListener('DOMContentLoaded', initEnhancedApp);

// ===== EXPORT ENHANCED FUNCTIONS =====
window.enhancedOrderSystem = {
  placeOrderEnhanced: placeOrderEnhanced,
  checkOrderLimits: checkOrderLimits,
  setupOrderStatusListener: setupOrderStatusListener,
  showOrderCompletedNotification: showOrderCompletedNotification
};

console.log('Part 3: Advanced Features Loaded');
</script>